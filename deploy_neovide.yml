---
# vim: set ft=yaml.ansible:

- name: Deploy Neovide
  hosts: localhost
  become: false
  vars:
    bin_dir: "{{ ansible_user_dir }}/.local/bin"
    desktop_dir: "{{ ansible_user_dir }}/.local/share/applications"
    icons_dir: "{{ ansible_user_dir }}/.local/share/icons"
    deploy_dir: "{{ playbook_dir }}"
    repo_url: "https://api.github.com/repos/neovide/neovide/releases/latest"
    filename: "neovide.AppImage"


  handlers:
    - name: Update desktop database
      ansible.builtin.command:
        cmd: update-desktop-database "{{ desktop_dir }}"
      register: desktop_db_update
      changed_when: desktop_db_update.rc == 0


  tasks:
    - name: Create directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0750'
      loop:
        - "{{ bin_dir }}"
        - "{{ desktop_dir }}"
        - "{{ icons_dir }}"

    - name: Fetch latest release information
      ansible.builtin.uri:
        url: "{{ repo_url }}"
        method: GET
        return_content: true
      register: release_info

    - name: Extract latest version
      ansible.builtin.set_fact:
        latest_version: "{{ release_info.json | json_query('tag_name') }}"

    - name: Check if Neovide is already installed
      ansible.builtin.command: "{{ bin_dir }}/neovide --version"
      register: installed_version
      failed_when: false
      changed_when: false

    - name: Set installation needed flag
      ansible.builtin.set_fact:
        install_needed: "{{ installed_version.rc != 0 or (installed_version.stdout | regex_replace('^neovide ', '') | default('') != latest_version) }}"

    - name: Display version information
      ansible.builtin.debug:
        msg: |
          Latest: {{ latest_version }}
          Installed: {{ installed_version.stdout | default('Not installed') }}
          Install needed: {{ install_needed }}

    - name: Download Neovide AppImage
      ansible.builtin.get_url:
        url: "https://github.com/neovide/neovide/releases/latest/download/{{ filename }}"
        dest: "{{ bin_dir }}/neovide_{{ latest_version }}"
        mode: "0750"
      register: neovide_download
      when: install_needed

    - name: Create symlink
      ansible.builtin.file:
        src: "{{ bin_dir }}/neovide_{{ latest_version }}"
        dest: "{{ bin_dir }}/neovide"
        state: link
      when: install_needed

    - name: Read neovide wrapper script
      ansible.builtin.slurp:
        src: "{{ deploy_dir }}/neovide-wrapper.sh"
      register: wrapper_script

    - name: Create neovide wrapper script with paths
      ansible.builtin.copy:
        content: "{{ wrapper_script.content | b64decode | regex_replace('BIN_DIR', bin_dir) | regex_replace('HOME', ansible_user_dir) }}"
        dest: "{{ bin_dir }}/neovide-wrapper.sh"
        mode: "0750"
      when: install_needed

    - name: Copy icon file
      ansible.builtin.copy:
        src: "{{ deploy_dir }}/neovide.svg"
        dest: "{{ icons_dir }}/neovide.svg"
        mode: "0640"

    - name: Read desktop file
      ansible.builtin.slurp:
        src: "{{ deploy_dir }}/neovide.desktop"
      register: desktop_file

    - name: Create desktop file with paths
      ansible.builtin.copy:
        content: "{{ desktop_file.content | b64decode | regex_replace('BIN_DIR', bin_dir) | regex_replace('HOME', ansible_user_dir) }}"
        dest: "{{ desktop_dir }}/neovide.desktop"
        mode: "0640"
      notify: Update desktop database

    - name: Check if neovim-remote is installed
      ansible.builtin.pip:
        name: neovim-remote
        state: present
      register: nvr_install
